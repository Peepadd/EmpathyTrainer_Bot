<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisis Pulse PRO+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap');
        body { font-family: 'Prompt', sans-serif; transition: background 0.5s ease; }
        
        .premium-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass-panel { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        #scoreRing { transition: stroke-dashoffset 0.1s linear; }
        .recording-pulse { animation: pulse-red 1.5s infinite; background: #ef4444 !important; color: white !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        /* PDF Page Break Helpers */
        .page-break { page-break-before: always; }
        .avoid-split { page-break-inside: avoid; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen text-slate-800 dark:text-slate-200">

    <div class="fixed top-0 left-0 w-full h-1 premium-gradient z-50"></div>

    <button onclick="toggleTheme()" class="fixed top-6 right-6 p-4 rounded-full glass-panel shadow-xl z-50 hover:scale-110 transition-transform">
        <span id="tIcon">üåô</span>
    </button>

    <div class="max-w-4xl mx-auto py-12 px-6">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-black mb-4 bg-clip-text text-transparent premium-gradient">Crisis Pulse Analyser</h1>
            <p class="text-slate-500 font-medium">‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏´‡πà‡∏á AI</p>
        </header>

        <div class="glass-panel p-8 rounded-[3rem] shadow-2xl mb-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-xs font-black uppercase tracking-widest text-indigo-500 mb-2">üé≠ Situation Context</label>
                    <select id="sitBox" class="w-full p-4 rounded-2xl bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 focus:ring-2 ring-indigo-500 outline-none transition-all">
                        <option value="‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏Å‡∏£‡∏ò">‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏Å‡∏£‡∏ò</option>
                        <option value="‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô">‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</option>
                        <option value="‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                        <option value="‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á">‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-black uppercase tracking-widest text-rose-500 mb-2">üö´ Forbidden Words</label>
                    <input id="forbidBox" type="text" class="w-full p-4 rounded-2xl bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700" value="‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à, ‡∏†‡∏≤‡∏£‡∏∞, ‡∏ä‡πà‡∏≤‡∏á‡∏°‡∏±‡∏ô">
                </div>
            </div>

            <div class="flex justify-between items-end mb-3">
                <span class="text-sm font-bold">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£:</span>
                <button id="voiceBtn" onclick="handleVoice()" class="flex items-center gap-2 px-5 py-2 rounded-full bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400 font-bold text-xs transition-all hover:bg-indigo-200">
                    <span id="vStatus">üé§ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)</span>
                </button>
            </div>
            <textarea id="txtInput" class="w-full h-40 p-6 rounded-[2rem] bg-white/50 dark:bg-slate-900/50 border-2 border-slate-100 dark:border-slate-800 focus:border-indigo-500 outline-none text-lg resize-none shadow-inner" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î..."></textarea>

            <button onclick="runAnalysis()" id="runBtn" class="w-full mt-8 premium-gradient text-white py-5 rounded-[2rem] font-black text-xl shadow-lg hover:brightness-110 active:scale-[0.98] transition-all">
                ANALYSE PERFORMANCE üöÄ
            </button>
        </div>

        <div id="resArea" class="hidden space-y-8 animate-in fade-in slide-in-from-bottom-10 duration-700">
            <div id="report-container" class="glass-panel p-10 rounded-[3rem] shadow-2xl overflow-hidden relative border-t-[12px] border-indigo-500">
                
                <div class="flex flex-col md:flex-row items-center gap-12 border-b border-slate-100 dark:border-slate-800 pb-10 mb-10">
                    <div class="relative flex items-center justify-center">
                        <svg class="w-48 h-48 transform -rotate-90 drop-shadow-2xl">
                            <circle cx="96" cy="96" r="88" stroke="currentColor" stroke-width="12" fill="transparent" class="text-slate-100 dark:text-slate-800"/>
                            <circle id="scoreRing" cx="96" cy="96" r="88" stroke="url(#grad)" stroke-width="12" fill="transparent" stroke-dasharray="553" stroke-dashoffset="553" stroke-linecap="round"/>
                            <defs>
                                <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#6366f1" />
                                    <stop offset="100%" style="stop-color:#ec4899" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute text-5xl font-black text-indigo-600 dark:text-indigo-400" id="scoreVal">0%</div>
                    </div>
                    <div class="text-center md:text-left flex-1">
                        <div id="toneTag" class="inline-block px-6 py-2 rounded-full text-xs font-black uppercase tracking-tighter mb-4 shadow-sm">Analyzing...</div>
                        <h2 class="text-4xl font-black mb-3">Communication Report</h2>
                        <p id="sumText" class="text-slate-500 dark:text-slate-400 leading-relaxed text-lg"></p>
                    </div>
                </div>

                <div id="dynamicBody" class="space-y-10"></div>
            </div>

            <div class="flex gap-6">
                <button onclick="exportToPDF()" class="flex-1 py-5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-[2rem] font-black text-lg shadow-xl hover:scale-105 transition-all">üìÑ SAVE AS PDF (MULTI-PAGE)</button>
                <button onclick="exportToIMG()" class="flex-1 py-5 bg-indigo-600 text-white rounded-[2rem] font-black text-lg shadow-xl hover:scale-105 transition-all">üì∏ SHARE IMAGE</button>
            </div>
        </div>

        <div id="histSec" class="mt-16 hidden">
            <h3 class="text-center text-xs font-black text-slate-400 uppercase tracking-widest mb-6">üìú Recent Analysis History</h3>
            <div id="histList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <script>
        // --- Continuous Voice Engine ---
        let recognition;
        let isRecording = false;

        function handleVoice() {
            if (!('webkitSpeechRecognition' in window)) return alert("Browser ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
            
            if (isRecording) {
                recognition.stop();
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = true; // ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏ß‡πÜ ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
            recognition.interimResults = true;
            recognition.lang = 'th-TH';

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('voiceBtn').classList.add('recording-pulse');
                document.getElementById('vStatus').innerText = "üõë ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á... (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î)";
            };

            recognition.onresult = (event) => {
                let finalStr = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalStr += event.results[i][0].transcript;
                }
                document.getElementById('txtInput').value += finalStr;
            };

            recognition.onend = () => {
                isRecording = false;
                document.getElementById('voiceBtn').classList.remove('recording-pulse');
                document.getElementById('vStatus').innerText = "üé§ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î (‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)";
            };

            recognition.start();
        }

        // --- Lerp Scoring Animation ---
        function animateScore(target) {
            const el = document.getElementById('scoreVal');
            const ring = document.getElementById('scoreRing');
            let curr = 0;
            const step = () => {
                const diff = target - curr;
                curr += diff * 0.1; // Lerp factor
                el.innerText = Math.round(curr) + "%";
                ring.style.strokeDashoffset = 553 - (curr / 100 * 553);
                if (Math.abs(diff) > 0.1) requestAnimationFrame(step);
                else { el.innerText = target + "%"; ring.style.strokeDashoffset = 553 - (target / 100 * 553); }
            };
            requestAnimationFrame(step);
        }

        // --- Core Analysis Logic ---
        async function runAnalysis() {
            const text = document.getElementById('txtInput').value.trim();
            const btn = document.getElementById('runBtn');
            if (!text) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°");

            btn.disabled = true;
            btn.innerText = "‚ö° QUANTUM ANALYSING...";

            try {
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        situation: document.getElementById('sitBox').value,
                        forbiddenWords: document.getElementById('forbidBox').value.split(',')
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                renderResult(data);
                saveHistory(text, data);
            } catch (err) {
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ANALYSE PERFORMANCE üöÄ";
            }
        }

        function renderResult(data) {
            document.getElementById('resArea').classList.remove('hidden');
            animateScore(data.score);

            const tag = document.getElementById('toneTag');
            tag.innerText = data.tone;
            const colors = { Professional: 'bg-emerald-100 text-emerald-600', Aggressive: 'bg-rose-100 text-rose-600', Neutral: 'bg-indigo-100 text-indigo-600', Passive: 'bg-slate-100 text-slate-600' };
            tag.className = `inline-block px-6 py-2 rounded-full text-xs font-black uppercase tracking-tighter mb-4 shadow-sm ${colors[data.tone] || colors.Neutral}`;

            document.getElementById('sumText').innerHTML = data.summary.replace(/\*\*(.*?)\*\*/g, '<b class="text-slate-900 dark:text-white">$1</b>');

            let bodyHtml = `
                <div class="grid md:grid-cols-2 gap-6 avoid-split">
                    <div class="p-8 rounded-[2rem] bg-emerald-50 dark:bg-emerald-900/10 border border-emerald-100 dark:border-emerald-800/30">
                        <h4 class="font-black text-emerald-700 mb-4 flex items-center gap-2">‚úÖ STRENGTHS</h4>
                        <ul class="space-y-3 text-sm">${data.pros.map(p => `<li>‚Ä¢ ${p}</li>`).join('')}</ul>
                    </div>
                    <div class="p-8 rounded-[2rem] bg-rose-50 dark:bg-rose-900/10 border border-rose-100 dark:border-rose-800/30">
                        <h4 class="font-black text-rose-700 mb-4 flex items-center gap-2">‚ö†Ô∏è IMPROVEMENTS</h4>
                        <ul class="space-y-3 text-sm">${data.cons.map(c => `<li>‚Ä¢ ${c}</li>`).join('')}</ul>
                    </div>
                </div>
                <div class="page-break"></div> <div class="avoid-split">
                    <h4 class="font-black text-indigo-600 mb-6 uppercase tracking-widest text-center">üí° Improvement Suggestions</h4>
                    <div class="rounded-[2rem] border dark:border-slate-800 overflow-hidden shadow-sm">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-900 font-bold">
                                <tr><th class="p-5">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th><th class="p-5">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î</th><th class="p-5 text-indigo-600">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th></tr>
                            </thead>
                            <tbody class="divide-y dark:divide-slate-800">
                                ${data.comparison_table.map(row => `
                                    <tr>
                                        <td class="p-5 font-bold">${row.aspect}</td>
                                        <td class="p-5 text-slate-500">${row.original}</td>
                                        <td class="p-5 font-bold text-emerald-600 bg-emerald-50/30 dark:bg-emerald-900/10">${row.better}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('dynamicBody').innerHTML = bodyHtml;
            document.getElementById('resArea').scrollIntoView({ behavior: 'smooth' });
        }

        // --- Multi-page PDF Export ---
        function exportToPDF() {
            const element = document.getElementById('report-container');
            const opt = {
                margin: 10,
                filename: 'Crisis_Report_Pro.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multiple Pages
            };
            html2pdf().set(opt).from(element).save();
        }

        function exportToIMG() {
            html2canvas(document.getElementById('report-container'), { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Crisis_Report.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // --- History & Theme ---
        const saveHistory = (input, data) => {
            const h = JSON.parse(localStorage.getItem('cp_hist') || '[]');
            h.unshift({ input, data, time: new Date().toLocaleTimeString() });
            localStorage.setItem('cp_hist', JSON.stringify(h.slice(0, 6)));
            renderHistory();
        };

        const renderHistory = () => {
            const h = JSON.parse(localStorage.getItem('cp_hist') || '[]');
            if (h.length) document.getElementById('histSec').classList.remove('hidden');
            document.getElementById('histList').innerHTML = h.map((item, i) => `
                <div onclick="loadHist(${i})" class="glass-panel p-5 rounded-3xl cursor-pointer hover:bg-white transition-all flex justify-between items-center border-l-4 border-indigo-500">
                    <span class="text-sm truncate w-40 italic">"${item.input}"</span>
                    <span class="font-black text-indigo-600">${item.data.score}%</span>
                </div>
            `).join('');
        };

        const loadHist = (i) => {
            const item = JSON.parse(localStorage.getItem('cp_hist'))[i];
            document.getElementById('txtInput').value = item.input;
            renderResult(item.data);
        };

        const toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            document.getElementById('tIcon').innerText = document.documentElement.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        };

        window.onload = renderHistory;
    </script>
</body>
</html>