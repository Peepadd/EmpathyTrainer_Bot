<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crisis Pulse Analyser PRO+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap');
        body { font-family: 'Prompt', sans-serif; transition: background-color 0.3s ease; }
        .glass-card { background: white; border: 1px solid #dbeafe; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .glass-card { background: #1e293b; border-color: #334155; }
        #scoreRing { transition: stroke-dashoffset 1s ease-out; stroke-linecap: round; }
        .tone-aggressive { border-top: 12px solid #ef4444; }
        .tone-professional { border-top: 12px solid #10b981; }
        .tone-passive { border-top: 12px solid #64748b; }
        .tone-neutral { border-top: 12px solid #3b82f6; }
        @keyframes pulse-red { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .recording { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        .avoid-break { page-break-inside: avoid; break-inside: avoid; }
    </style>
</head>
<body class="flex flex-col items-center py-10 px-4 bg-slate-50 dark:bg-slate-900 min-h-screen text-slate-800 dark:text-slate-100">

    <button onclick="UI.toggleDarkMode()" class="absolute top-4 right-4 p-3 rounded-full bg-white dark:bg-slate-800 shadow-lg z-10">
        <span id="themeIcon">üåô</span>
    </button>

    <div id="errorModal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </div>
            <h3 class="text-xl font-bold mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <p id="modalMsg" class="text-slate-500 dark:text-slate-400 text-sm mb-6"></p>
            <button onclick="UI.closeModal()" class="w-full bg-slate-800 dark:bg-blue-600 text-white py-3 rounded-xl font-bold">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <header class="w-full max-w-3xl text-center mb-10">
        <h1 class="text-4xl font-extrabold text-blue-900 dark:text-blue-400">Crisis Pulse <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded-md">PRO+</span></h1>
        <p class="mt-2 text-slate-500">AI Communication Performance Analyzer</p>
    </header>

    <main class="w-full max-w-3xl glass-card p-6 md:p-10 rounded-[2.5rem] shadow-xl relative mb-10">
        <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-bold mb-2 text-blue-800 dark:text-blue-300">üé≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
                <select id="situationSelect" onchange="UI.toggleCustomSituation()" class="w-full p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-700">
                    <option value="‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏¢/‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå‡∏á‡∏≤‡∏ô</option>
                    <option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP ‡πÇ‡∏ß‡∏¢‡∏ß‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏ß‡∏¢‡∏ß‡∏≤‡∏¢</option>
                    <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô">‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</option>
                    <option value="custom">‚ú® ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á...</option>
                </select>
                <input type="text" id="customSituation" class="hidden mt-2 w-full p-3 rounded-xl border dark:bg-slate-800" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå...">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2 text-blue-800 dark:text-blue-300">üö´ ‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°</label>
                <input type="text" id="forbiddenWordsInput" class="w-full p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-700" value="‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à, ‡∏†‡∏≤‡∏£‡∏∞">
            </div>
        </div>

        <div class="flex justify-between items-center mb-2">
            <label class="text-sm font-bold">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
            <button id="micBtn" onclick="Voice.toggle()" class="text-xs bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-full flex items-center gap-1">
                üé§ <span id="micText">‡∏û‡∏π‡∏î‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</span>
            </button>
        </div>
        <textarea id="userInput" class="w-full p-4 rounded-2xl border dark:bg-slate-900 min-h-[120px] focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏û‡∏π‡∏î..."></textarea>

        <button onclick="App.analyze()" id="btn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold transition-all transform active:scale-95 shadow-lg">
            üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
        </button>
    </main>

    <div id="skeletonLoader" class="hidden w-full max-w-3xl p-10 glass-card rounded-[3rem] animate-pulse">
        <div class="h-40 w-40 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-8"></div>
        <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mx-auto mb-4"></div>
        <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mx-auto"></div>
    </div>

    <section id="result" class="hidden w-full max-w-3xl p-8 md:p-12 glass-card rounded-[3rem] mb-10">
        <div id="capture-area" class="bg-white dark:bg-slate-800 p-4 rounded-2xl">
            <div class="flex flex-col md:flex-row items-center gap-8 border-b pb-8 mb-8 avoid-break">
                <div class="relative flex items-center justify-center">
                    <svg class="w-32 h-32" viewBox="0 0 128 128" style="transform: rotate(-90deg);">
                        <circle cx="64" cy="64" r="56" stroke="currentColor" class="text-slate-100 dark:text-slate-700" stroke-width="10" fill="none" />
                        <circle id="scoreRing" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="10" fill="none" stroke-dasharray="351.85" stroke-dashoffset="351.85" />
                    </svg>
                    <span id="scoreValue" class="absolute text-3xl font-bold">0%</span>
                </div>
                <div class="text-center md:text-left">
                    <div id="toneBadge" class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase mb-2">Analyzing</div>
                    <h2 class="text-2xl font-bold">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</h2>
                </div>
            </div>
            <div id="reportContent"></div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mt-8">
            <button onclick="Exporter.run('pdf')" class="py-3 bg-red-500 text-white rounded-xl font-bold text-sm shadow-md">PDF Report</button>
            <button onclick="Exporter.run('image')" class="py-3 bg-emerald-500 text-white rounded-xl font-bold text-sm shadow-md">Save Image</button>
        </div>
    </section>

    <section id="historySection" class="w-full max-w-3xl hidden">
        <h3 class="text-center text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">History</h3>
        <div id="historyList" class="grid gap-3"></div>
    </section>

    <script>
        /**
         * Core Application Logic
         */
        const App = {
            async analyze() {
                const text = document.getElementById('userInput').value.trim();
                if (!text) return UI.showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå");

                const situation = UI.getSituation();
                const forbidden = document.getElementById('forbiddenWordsInput').value.split(',').map(s => s.trim());
                
                UI.setLoading(true);

                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, situation, forbiddenWords: forbidden })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || "Server Error");

                    this.renderResult(data);
                    this.saveHistory(text, data);
                } catch (err) {
                    UI.showError(err.message);
                } finally {
                    UI.setLoading(false);
                }
            },

            renderResult(data) {
                UI.animateScore(data.score);
                UI.setTone(data.tone);

                const report = document.getElementById('reportContent');
                report.innerHTML = `
                    <div class="mb-6 avoid-break">
                        <p class="text-slate-600 dark:text-slate-400 leading-relaxed">${this.format(data.summary)}</p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-800">
                            <h4 class="font-bold text-emerald-700 mb-2">‚úÖ ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô</h4>
                            <ul class="text-xs space-y-1">${data.pros.map(p => `<li>‚Ä¢ ${this.format(p)}</li>`).join('')}</ul>
                        </div>
                        <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-800">
                            <h4 class="font-bold text-red-700 mb-2">‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</h4>
                            <ul class="text-xs space-y-1">${data.cons.map(c => `<li>‚Ä¢ ${this.format(c)}</li>`).join('')}</ul>
                        </div>
                    </div>
                    ${this.renderTable(data.comparison_table)}
                `;
            },

            renderTable(table) {
                if (!table?.length) return '';
                return `
                    <div class="mt-4 border rounded-xl overflow-hidden text-sm avoid-break">
                        <table class="w-full text-left border-collapse">
                            <tr class="bg-slate-50 dark:bg-slate-700/50 font-bold">
                                <th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô</th><th class="p-3">‡πÄ‡∏î‡∏¥‡∏°</th><th class="p-3">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th>
                            </tr>
                            ${table.map(row => `
                                <tr class="border-t dark:border-slate-700">
                                    <td class="p-3 font-semibold">${row.aspect}</td>
                                    <td class="p-3 text-slate-500">${row.original}</td>
                                    <td class="p-3 text-emerald-600 font-medium">${row.better}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            },

            format: (t) => t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'),

            saveHistory(input, data) {
                const history = JSON.parse(localStorage.getItem('crisis_history') || '[]');
                history.unshift({ input, data, time: new Date().toLocaleTimeString() });
                localStorage.setItem('crisis_history', JSON.stringify(history.slice(0, 5)));
                UI.updateHistoryUI();
            }
        };

        /**
         * UI Manipulation
         */
        const UI = {
            toggleDarkMode() {
                const isDark = document.documentElement.classList.toggle('dark');
                document.getElementById('themeIcon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
            },
            toggleCustomSituation() {
                const isCustom = document.getElementById('situationSelect').value === 'custom';
                document.getElementById('customSituation').classList.toggle('hidden', !isCustom);
            },
            getSituation() {
                const sel = document.getElementById('situationSelect').value;
                return sel === 'custom' ? document.getElementById('customSituation').value : sel;
            },
            setLoading(isLoading) {
                document.getElementById('btn').disabled = isLoading;
                document.getElementById('btn').innerText = isLoading ? '‚è≥ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...' : 'üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û';
                document.getElementById('skeletonLoader').classList.toggle('hidden', !isLoading);
                document.getElementById('result').classList.add('hidden');
            },
            showError(msg) {
                document.getElementById('modalMsg').innerText = msg;
                document.getElementById('errorModal').classList.remove('hidden');
            },
            closeModal() { document.getElementById('errorModal').classList.add('hidden'); },
            animateScore(target) {
                const ring = document.getElementById('scoreRing');
                const val = document.getElementById('scoreValue');
                ring.style.strokeDashoffset = 351.85 - (target / 100 * 351.85);
                let current = 0;
                const timer = setInterval(() => {
                    if (current >= target) clearInterval(timer);
                    val.innerText = `${current}%`;
                    current++;
                }, 15);
                document.getElementById('result').classList.remove('hidden');
            },
            setTone(tone) {
                const config = {
                    Professional: { color: 'bg-emerald-100 text-emerald-700', border: 'tone-professional' },
                    Aggressive: { color: 'bg-red-100 text-red-700', border: 'tone-aggressive' },
                    Passive: { color: 'bg-slate-100 text-slate-600', border: 'tone-passive' },
                    Neutral: { color: 'bg-blue-100 text-blue-700', border: 'tone-neutral' }
                };
                const { color, border } = config[tone] || config.Neutral;
                const res = document.getElementById('result');
                res.className = `w-full max-w-3xl p-8 md:p-12 glass-card rounded-[3rem] mb-10 transition-all ${border}`;
                document.getElementById('toneBadge').className = `inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase mb-2 ${color}`;
                document.getElementById('toneBadge').innerText = tone;
            },
            updateHistoryUI() {
                const history = JSON.parse(localStorage.getItem('crisis_history') || '[]');
                if (!history.length) return;
                document.getElementById('historySection').classList.remove('hidden');
                document.getElementById('historyList').innerHTML = history.map((h, i) => `
                    <div class="p-4 glass-card rounded-2xl text-sm flex justify-between items-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800" onclick="UI.loadFromHistory(${i})">
                        <span class="truncate pr-4 italic">"${h.input}"</span>
                        <span class="font-bold text-blue-600">${h.data.score}%</span>
                    </div>
                `).join('');
            },
            loadFromHistory(index) {
                const item = JSON.parse(localStorage.getItem('crisis_history'))[index];
                document.getElementById('userInput').value = item.input;
                App.renderResult(item.data);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        /**
         * Voice Recognition
         */
        const Voice = {
            recognition: null,
            isRecording: false,
            init() {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return document.getElementById('micBtn').remove();
                this.recognition = new Speech();
                this.recognition.lang = 'th-TH';
                this.recognition.onresult = (e) => {
                    document.getElementById('userInput').value += e.results[0][0].transcript;
                };
                this.recognition.onend = () => this.stop();
            },
            toggle() { this.isRecording ? this.stop() : this.start(); },
            start() {
                this.recognition.start();
                this.isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('micText').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
            },
            stop() {
                this.recognition.stop();
                this.isRecording = false;
                document.getElementById('micBtn').classList.remove('recording');
                document.getElementById('micText').innerText = '‡∏û‡∏π‡∏î‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå';
            }
        };

        /**
         * Exporter (PDF/Image)
         */
        const Exporter = {
            async run(type) {
                const area = document.getElementById('capture-area');
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) document.documentElement.classList.remove('dark');

                // Wait for layout shift
                await new Promise(r => setTimeout(r, 400));

                if (type === 'pdf') {
                    const opt = { 
                        margin: 10, filename: 'crisis-report.pdf', 
                        image: { type: 'jpeg', quality: 0.98 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
                    };
                    await html2pdf().set(opt).from(area).save();
                } else {
                    const canvas = await html2canvas(area, { scale: 2 });
                    const link = document.createElement('a');
                    link.download = 'crisis-report.png';
                    link.href = canvas.toDataURL();
                    link.click();
                }

                if (isDark) document.documentElement.classList.add('dark');
            }
        };

        window.onload = () => {
            Voice.init();
            UI.updateHistoryUI();
        };
    </script>
</body>
</html>