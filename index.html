<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crisis Pulse Analyser PRO+ üöÄ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap');
        body { font-family: 'Prompt', sans-serif; transition: background-color 0.3s ease; }
        .glass-card { background: white; border: 1px solid #dbeafe; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .dark .glass-card { background: #1e293b; border-color: #334155; }
        #scoreRing { transition: stroke-dashoffset 1s ease-out; stroke-linecap: round; }
        .tone-aggressive { border-top: 12px solid #ef4444; }
        .tone-professional { border-top: 12px solid #10b981; }
        .tone-passive { border-top: 12px solid #64748b; }
        .tone-neutral { border-top: 12px solid #3b82f6; }
        @keyframes pulse-red { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .recording { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; color: white !important; }
        .avoid-break { page-break-inside: avoid; break-inside: avoid; }
    </style>
</head>
<body class="flex flex-col items-center py-10 px-4 bg-slate-50 dark:bg-slate-900 min-h-screen text-slate-800 dark:text-slate-100">

    <button onclick="UI.toggleDarkMode()" class="absolute top-4 right-4 p-3 rounded-full bg-white dark:bg-slate-800 shadow-lg z-10 hover:scale-110 transition-transform">
        <span id="themeIcon">üåô</span>
    </button>

    <div id="errorModal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl scale-in">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </div>
            <h3 class="text-xl font-bold mb-2">‡∏≠‡∏∏‡πä‡∏õ‡∏™‡πå! ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‚ö†Ô∏è</h3>
            <p id="modalMsg" class="text-slate-500 dark:text-slate-400 text-sm mb-6"></p>
            <button onclick="UI.closeModal()" class="w-full bg-slate-800 dark:bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß üëå</button>
        </div>
    </div>

    <header class="w-full max-w-3xl text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-extrabold text-blue-900 dark:text-blue-400 tracking-tight">Crisis Pulse <span class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-xs px-3 py-1 rounded-full uppercase">PRO+ üöÄ</span></h1>
        <p class="mt-3 text-slate-500 font-medium">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ "‡∏Ñ‡∏°" ‡πÅ‡∏•‡∏∞ "‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û" ‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ AI ‚ú®</p>
    </header>

    <main class="w-full max-w-3xl glass-card p-6 md:p-10 rounded-[2.5rem] shadow-2xl relative mb-10 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500"></div>
        
        <div class="grid md:grid-cols-2 gap-5 mb-8">
            <div>
                <label class="block text-sm font-bold mb-2 text-blue-900 dark:text-blue-300">üé≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</label>
                <select id="situationSelect" onchange="UI.toggleCustomSituation()" class="w-full p-3.5 rounded-xl border-2 border-slate-100 dark:border-slate-700 dark:bg-slate-800 focus:border-blue-400 outline-none transition-all">
                    <option value="‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå">üì± ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏¢/‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå</option>
                    <option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP ‡πÇ‡∏ß‡∏¢‡∏ß‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô">üò§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏ß‡∏¢‡∏ß‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</option>
                    <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô">üíº ‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô (‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô)</option>
                    <option value="custom">‚ú® ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏≠‡∏á...</option>
                </select>
                <input type="text" id="customSituation" class="hidden mt-3 w-full p-3.5 rounded-xl border-2 border-blue-100 dark:bg-slate-800 focus:border-blue-400 outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2 text-blue-900 dark:text-blue-300">üö´ ‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ</label>
                <input type="text" id="forbiddenWordsInput" class="w-full p-3.5 rounded-xl border-2 border-slate-100 dark:border-slate-700 dark:bg-slate-800 focus:border-red-300 outline-none transition-all" value="‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à, ‡∏†‡∏≤‡∏£‡∏∞, ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            </div>
        </div>

        <div class="flex justify-between items-center mb-3">
            <label class="text-sm font-bold text-slate-700 dark:text-slate-300">üí¨ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:</label>
            <button id="micBtn" onclick="Voice.toggle()" class="text-xs bg-blue-100 dark:bg-blue-900/40 px-4 py-2 rounded-full flex items-center gap-2 font-bold text-blue-700 dark:text-blue-300 hover:bg-blue-200 transition-colors">
                üé§ <span id="micText">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î</span>
            </button>
        </div>
        <textarea id="userInput" class="w-full p-5 rounded-3xl border-2 border-slate-100 dark:bg-slate-900 dark:border-slate-800 min-h-[160px] focus:ring-4 focus:ring-blue-500/10 focus:border-blue-400 outline-none shadow-inner text-lg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>

        <button onclick="App.analyze()" id="btn" class="w-full mt-8 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white py-5 rounded-2xl font-bold text-lg transition-all transform active:scale-95 shadow-xl flex justify-center items-center gap-2">
            üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
        </button>
    </main>

    <div id="skeletonLoader" class="hidden w-full max-w-3xl p-10 glass-card rounded-[3rem] animate-pulse">
        <div class="h-32 w-32 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-8"></div>
        <div class="h-6 bg-slate-200 dark:bg-slate-700 rounded w-3/4 mx-auto mb-4"></div>
        <div class="h-4 bg-slate-200 dark:bg-slate-700 rounded w-1/2 mx-auto"></div>
    </div>

    <section id="result" class="hidden w-full max-w-3xl p-8 md:p-12 glass-card rounded-[3rem] mb-10 shadow-2xl border-t-[12px]">
        <div id="capture-area" class="bg-white dark:bg-slate-800 p-6 rounded-3xl">
            <div class="flex flex-col md:flex-row items-center gap-10 border-b border-slate-100 dark:border-slate-700 pb-10 mb-8 avoid-break">
                <div class="relative flex items-center justify-center">
                    <svg class="w-36 h-36 drop-shadow-md" viewBox="0 0 128 128" style="transform: rotate(-90deg);">
                        <circle cx="64" cy="64" r="56" stroke="currentColor" class="text-slate-100 dark:text-slate-700" stroke-width="10" fill="none" />
                        <circle id="scoreRing" cx="64" cy="64" r="56" stroke="#3b82f6" stroke-width="10" fill="none" stroke-dasharray="351.85" stroke-dashoffset="351.85" />
                    </svg>
                    <span id="scoreValue" class="absolute text-4xl font-black text-blue-900 dark:text-white">0%</span>
                </div>
                <div class="text-center md:text-left flex-1">
                    <div id="toneBadge" class="inline-flex items-center px-4 py-1.5 rounded-full text-[11px] font-black uppercase mb-3 shadow-sm tracking-widest">Analyzing...</div>
                    <h2 class="text-3xl font-extrabold text-slate-800 dark:text-white mb-1">‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• üìã</h2>
                    <p class="text-slate-500 font-medium">‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</p>
                </div>
            </div>
            <div id="reportContent" class="space-y-8"></div>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-10">
            <button onclick="Exporter.run('pdf')" id="pdfBtn" class="py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold flex justify-center items-center gap-2 shadow-lg transition-all">üìÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</button>
            <button onclick="Exporter.run('image')" id="imgBtn" class="py-4 bg-emerald-500 hover:bg-emerald-600 text-white rounded-2xl font-bold flex justify-center items-center gap-2 shadow-lg transition-all">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </section>

    <section id="historySection" class="w-full max-w-3xl hidden mb-24">
        <h3 class="text-center text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-6">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="historyList" class="grid gap-4"></div>
    </section>

    <script>
        const App = {
            async analyze() {
                const text = document.getElementById('userInput').value.trim();
                if (!text) return UI.showError("‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡πâ‡∏≤‡∏ö! üòä");

                const situation = UI.getSituation();
                const forbidden = document.getElementById('forbiddenWordsInput').value.split(',').map(s => s.trim());
                
                UI.setLoading(true);

                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text, situation, forbiddenWords: forbidden })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞!");

                    this.renderResult(data);
                    this.saveHistory(text, data);
                } catch (err) {
                    UI.showError(err.message);
                } finally {
                    UI.setLoading(false);
                }
            },

            renderResult(data) {
                UI.animateScore(data.score);
                UI.setTone(data.tone);

                const report = document.getElementById('reportContent');
                report.innerHTML = `
                    <div class="avoid-break bg-blue-50/50 dark:bg-slate-700/30 p-6 rounded-[2rem] border border-blue-100 dark:border-slate-700">
                        <h4 class="font-bold text-blue-900 dark:text-blue-300 text-xl mb-3 flex items-center gap-2">üìù ‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h4>
                        <p class="text-slate-600 dark:text-slate-300 leading-relaxed text-lg">${this.format(data.summary)}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6 avoid-break">
                        <div class="p-6 bg-emerald-50/60 dark:bg-emerald-900/10 rounded-[2rem] border border-emerald-100 dark:border-emerald-800/30">
                            <h4 class="font-bold text-emerald-700 dark:text-emerald-400 mb-4 flex items-center gap-2">‚úÖ ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
                            <ul class="space-y-3">${data.pros.map(p => `<li class="flex items-start gap-2 text-sm"><span class="text-emerald-500">‚úî</span><span>${this.format(p)}</span></li>`).join('')}</ul>
                        </div>
                        <div class="p-6 bg-red-50/60 dark:bg-red-900/10 rounded-[2rem] border border-red-100 dark:border-red-800/30">
                            <h4 class="font-bold text-red-700 dark:text-red-400 mb-4 flex items-center gap-2">‚ö†Ô∏è ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÑ‡∏î‡πâ</h4>
                            <ul class="space-y-3">${data.cons.map(c => `<li class="flex items-start gap-2 text-sm"><span class="text-red-500">‚úò</span><span>${this.format(c)}</span></li>`).join('')}</ul>
                        </div>
                    </div>

                    <div class="avoid-break">
                        <h4 class="font-bold text-slate-800 dark:text-white text-xl mb-4 flex items-center gap-2">üí° ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Best Practice)</h4>
                        <div class="border dark:border-slate-700 rounded-3xl overflow-hidden shadow-sm">
                            <table class="w-full text-left">
                                <thead class="bg-slate-800 dark:bg-slate-700 text-white text-xs uppercase tracking-wider">
                                    <tr>
                                        <th class="p-4 w-1/4">‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô</th><th class="p-4 w-1/3 text-red-200">‡πÄ‡∏î‡∏¥‡∏°</th><th class="p-4 text-emerald-300">‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ ‚ú®</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y dark:divide-slate-700">
                                    ${data.comparison_table.map(row => `
                                        <tr class="bg-white dark:bg-slate-800/50 hover:bg-slate-50 transition-colors">
                                            <td class="p-4 text-sm font-bold text-slate-700 dark:text-slate-300">${row.aspect}</td>
                                            <td class="p-4 text-xs text-slate-500 italic">"${row.original}"</td>
                                            <td class="p-4 text-sm text-emerald-600 dark:text-emerald-400 font-bold bg-emerald-50/20">${this.format(row.better)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            format: (t) => t.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-slate-900 dark:text-white">$1</strong>'),

            saveHistory(input, data) {
                const history = JSON.parse(localStorage.getItem('crisis_history_v2') || '[]');
                history.unshift({ input, data, time: new Date().toLocaleString('th-TH') });
                localStorage.setItem('crisis_history_v2', JSON.stringify(history.slice(0, 5)));
                UI.updateHistoryUI();
            }
        };

        const UI = {
            toggleDarkMode() {
                const isDark = document.documentElement.classList.toggle('dark');
                document.getElementById('themeIcon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            },
            toggleCustomSituation() {
                const isCustom = document.getElementById('situationSelect').value === 'custom';
                document.getElementById('customSituation').classList.toggle('hidden', !isCustom);
            },
            getSituation() {
                const sel = document.getElementById('situationSelect').value;
                return sel === 'custom' ? document.getElementById('customSituation').value : sel;
            },
            setLoading(isLoading) {
                const btn = document.getElementById('btn');
                btn.disabled = isLoading;
                btn.innerHTML = isLoading ? '‚è≥ AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì...' : 'üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û';
                document.getElementById('skeletonLoader').classList.toggle('hidden', !isLoading);
                if(isLoading) document.getElementById('result').classList.add('hidden');
            },
            showError(msg) {
                document.getElementById('modalMsg').innerText = msg;
                document.getElementById('errorModal').classList.remove('hidden');
            },
            closeModal() { document.getElementById('errorModal').classList.add('hidden'); },
            animateScore(target) {
                const ring = document.getElementById('scoreRing');
                const val = document.getElementById('scoreValue');
                ring.style.strokeDashoffset = 351.85 - (target / 100 * 351.85);
                let current = 0;
                const timer = setInterval(() => {
                    if (current >= target) { clearInterval(timer); val.innerText = `${target}%`; } 
                    else { current++; val.innerText = `${current}%`; }
                }, 15);
                document.getElementById('result').classList.remove('hidden');
            },
            setTone(tone) {
                const config = {
                    Professional: { color: 'bg-emerald-100 text-emerald-700', border: 'tone-professional', label: 'üü¢ ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏™‡∏∏‡∏î‡πÜ' },
                    Aggressive: { color: 'bg-red-100 text-red-700', border: 'tone-aggressive', label: 'üî¥ ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏∞‡∏ó‡∏∞' },
                    Passive: { color: 'bg-slate-200 text-slate-600', border: 'tone-passive', label: '‚ö™ ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏´‡∏á‡∏≤‡πÑ‡∏õ‡∏ô‡∏¥‡∏î' },
                    Neutral: { color: 'bg-blue-100 text-blue-700', border: 'tone-neutral', label: 'üîµ ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' }
                };
                const { color, border, label } = config[tone] || config.Neutral;
                const res = document.getElementById('result');
                res.className = `w-full max-w-3xl p-8 md:p-12 glass-card rounded-[3rem] mb-10 shadow-2xl transition-all ${border}`;
                const badge = document.getElementById('toneBadge');
                badge.className = `inline-flex items-center px-4 py-1.5 rounded-full text-[11px] font-black uppercase mb-3 shadow-sm tracking-widest ${color}`;
                badge.innerText = label;
            },
            updateHistoryUI() {
                const history = JSON.parse(localStorage.getItem('crisis_history_v2') || '[]');
                if (!history.length) return;
                document.getElementById('historySection').classList.remove('hidden');
                document.getElementById('historyList').innerHTML = history.map((h, i) => `
                    <div class="p-5 glass-card rounded-2xl text-sm flex justify-between items-center cursor-pointer hover:border-blue-400 transition-colors shadow-sm" onclick="UI.loadFromHistory(${i})">
                        <div class="flex-1 truncate pr-4 italic text-slate-500">"${h.input}"</div>
                        <div class="font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-lg">${h.data.score}%</div>
                    </div>
                `).join('');
            },
            loadFromHistory(index) {
                const item = JSON.parse(localStorage.getItem('crisis_history_v2'))[index];
                document.getElementById('userInput').value = item.input;
                App.renderResult(item.data);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        const Voice = {
            recognition: null, isRecording: false,
            init() {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Speech) return document.getElementById('micBtn').remove();
                this.recognition = new Speech(); this.recognition.lang = 'th-TH';
                this.recognition.onresult = (e) => document.getElementById('userInput').value += e.results[0][0].transcript;
                this.recognition.onend = () => this.stop();
            },
            toggle() { this.isRecording ? this.stop() : this.start(); },
            start() { 
                try { this.recognition.start(); this.isRecording = true; document.getElementById('micBtn').classList.add('recording'); document.getElementById('micText').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á... (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î)'; } 
                catch(e) {} 
            },
            stop() { this.recognition.stop(); this.isRecording = false; document.getElementById('micBtn').classList.remove('recording'); document.getElementById('micText').innerText = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î'; }
        };

        const Exporter = {
            async run(type) {
                const area = document.getElementById('capture-area');
                const isDark = document.documentElement.classList.contains('dark');
                const btn = type === 'pdf' ? document.getElementById('pdfBtn') : document.getElementById('imgBtn');
                const originalText = btn.innerHTML;

                btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå...';
                btn.disabled = true;

                // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ PDF ‡∏ß‡πà‡∏≤‡∏á: ‡∏õ‡∏¥‡∏î Dark Mode ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ UI ‡∏ô‡∏¥‡πà‡∏á
                if (isDark) document.documentElement.classList.remove('dark');
                await new Promise(r => setTimeout(r, 800)); 

                try {
                    if (type === 'pdf') {
                        const opt = { 
                            margin: [10, 10, 10, 10], 
                            filename: `Crisis-Pulse-Report-${Date.now()}.pdf`, 
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
                        };
                        await html2pdf().set(opt).from(area).save();
                    } else {
                        const canvas = await html2canvas(area, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                        const link = document.createElement('a');
                        link.download = `Crisis-Pulse-Report-${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    }
                } catch (err) {
                    UI.showError("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    if (isDark) document.documentElement.classList.add('dark');
                }
            }
        };

        window.onload = () => {
            Voice.init(); UI.updateHistoryUI();
            if(localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) UI.toggleDarkMode();
        };
    </script>
</body>
</html>