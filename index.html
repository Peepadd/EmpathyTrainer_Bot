<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crisis Pulse Analyser PRO+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f5f0;
            --surface: #ffffff;
            --border: #e8e2d9;
            --text: #1a1510;
            --text-muted: #7a6f64;
            --accent: #d4500a;
            --accent-light: #fff0e8;
            --accent2: #1a4f8a;
            --accent2-light: #e8f0ff;
            --green: #1a6b3a;
            --green-light: #e8f5ee;
            --red: #c0211f;
            --red-light: #fdecea;
            --ring-offset: 351.85;
        }
        .dark {
            --bg: #0f0e0c;
            --surface: #1a1916;
            --border: #2d2b27;
            --text: #f0ece6;
            --text-muted: #8a8278;
            --accent: #e8622a;
            --accent-light: #2d1a0a;
            --accent2: #4a80c4;
            --accent2-light: #0a1a2d;
            --green: #3aaf6a;
            --green-light: #0a2d1a;
            --red: #e05250;
            --red-light: #2d0a0a;
        }

        * { transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease; }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, .font-display { font-family: 'Syne', sans-serif; }

        /* Noise texture overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
            opacity: 0.4;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            position: relative;
        }

        .card-elevated {
            box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
        }

        .dark .card-elevated {
            box-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 1px 4px rgba(0,0,0,0.2);
        }

        .accent-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 20px 20px 0 0;
        }

        /* Input styles */
        .input-field {
            width: 100%;
            background: var(--bg);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-family: 'Sarabun', sans-serif;
            font-size: 14px;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 12%, transparent);
        }
        .input-field::placeholder { color: var(--text-muted); }

        textarea.input-field { resize: vertical; min-height: 140px; line-height: 1.7; font-size: 15px; }

        /* Button */
        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 14px;
            font-family: 'Syne', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.15s, box-shadow 0.15s, background 0.2s;
            box-shadow: 0 4px 16px color-mix(in srgb, var(--accent) 30%, transparent);
            letter-spacing: 0.02em;
        }
        .btn-primary:hover:not(:disabled) {
            background: color-mix(in srgb, var(--accent) 85%, black);
            transform: translateY(-1px);
            box-shadow: 0 8px 24px color-mix(in srgb, var(--accent) 35%, transparent);
        }
        .btn-primary:active:not(:disabled) { transform: translateY(0); }
        .btn-primary:disabled { opacity: 0.65; cursor: not-allowed; }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1.5px solid var(--border);
            padding: 12px 20px;
            border-radius: 12px;
            font-family: 'Sarabun', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }
        .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

        /* Score ring */
        #scoreRing { transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Tone indicators */
        .tone-strip { height: 4px; border-radius: 0 0 20px 20px; transition: background 0.4s; }

        /* Tags */
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.03em;
        }
        .tag-red { background: var(--red-light); color: var(--red); border: 1px solid color-mix(in srgb, var(--red) 20%, transparent); }
        .tag-green { background: var(--green-light); color: var(--green); border: 1px solid color-mix(in srgb, var(--green) 20%, transparent); }
        .tag-blue { background: var(--accent2-light); color: var(--accent2); border: 1px solid color-mix(in srgb, var(--accent2) 20%, transparent); }
        .tag-orange { background: var(--accent-light); color: var(--accent); border: 1px solid color-mix(in srgb, var(--accent) 20%, transparent); }

        /* Modal */
        .modal-backdrop {
            position: fixed; inset: 0; z-index: 50;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(6px);
            display: flex; align-items: center; justify-content: center;
            padding: 16px;
        }
        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 36px 32px;
            max-width: 400px; width: 100%;
            text-align: center;
            animation: modalIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.88) translateY(12px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Skeleton shimmer */
        .shimmer {
            background: linear-gradient(90deg, var(--border) 25%, color-mix(in srgb, var(--border) 60%, var(--surface)) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

        /* Recording pulse */
        @keyframes recPulse {
            0%, 100% { box-shadow: 0 0 0 0 color-mix(in srgb, var(--red) 40%, transparent); }
            50% { box-shadow: 0 0 0 8px color-mix(in srgb, var(--red) 0%, transparent); }
        }
        .recording { animation: recPulse 1.2s infinite; background: var(--red) !important; color: white !important; }

        /* Char counter */
        .char-warn { color: #d97706; font-weight: 700; }
        .char-danger { color: var(--red); font-weight: 700; }

        /* Table */
        .result-table { width: 100%; border-collapse: collapse; }
        .result-table th {
            background: color-mix(in srgb, var(--accent2) 10%, var(--surface));
            color: var(--accent2);
            font-family: 'Syne', sans-serif;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 2px solid var(--border);
        }
        .result-table td {
            padding: 14px 16px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
            color: var(--text);
        }
        .result-table tr:last-child td { border-bottom: none; }
        .result-table tr:nth-child(even) td { background: color-mix(in srgb, var(--border) 30%, var(--surface)); }

        /* Section label */
        .section-label {
            font-family: 'Syne', sans-serif;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        /* Fade-in */
        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Score label */
        .score-label-excellent { color: var(--green); }
        .score-label-good { color: var(--accent2); }
        .score-label-average { color: #d97706; }
        .score-label-poor { color: var(--red); }

        /* Divider */
        .divider { height: 1px; background: var(--border); }

        /* Theme toggle */
        #themeToggle {
            position: fixed; top: 20px; right: 20px; z-index: 10;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        #themeToggle:hover { transform: scale(1.1); }

        /* List items */
        .list-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            font-size: 14px;
            color: var(--text);
            line-height: 1.6;
        }
        .list-item + .list-item { border-top: 1px solid var(--border); }
        .list-dot {
            width: 20px; height: 20px; flex-shrink: 0;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; margin-top: 2px;
        }

        select.input-field { cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a8278' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px;
        }

        /* Forbidden tags */
        .forbidden-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 10px; border-radius: 100px;
            font-size: 11px; font-weight: 700; margin: 2px;
            background: var(--red-light); color: var(--red);
            border: 1px solid color-mix(in srgb, var(--red) 15%, transparent);
        }

        /* Score colors */
        .ring-excellent { stroke: #1a6b3a !important; }
        .ring-good { stroke: #1a4f8a !important; }
        .ring-average { stroke: #d97706 !important; }
        .ring-poor { stroke: #c0211f !important; }
    </style>
</head>
<body>
    <button id="themeToggle" onclick="toggleDark()">
        <span id="themeIcon">üåô</span>
    </button>

    <!-- Error Modal -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-box">
            <div style="width:56px;height:56px;background:var(--red-light);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:24px;">‚ö†Ô∏è</div>
            <h3 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:8px;">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p id="modalMsg" style="color:var(--text-muted);font-size:14px;line-height:1.6;margin-bottom:24px;"></p>
            <button onclick="closeModal()" class="btn-primary" style="padding:12px 24px;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
        </div>
    </div>

    <div style="max-width:680px;margin:0 auto;padding:60px 16px 80px;position:relative;z-index:1;">

        <!-- Header -->
        <div style="text-align:center;margin-bottom:48px;">
            <div style="display:inline-flex;align-items:center;gap:8px;margin-bottom:16px;">
                <div style="width:8px;height:8px;background:var(--accent);border-radius:50%;"></div>
                <span class="section-label">Crisis Communication Intelligence</span>
                <div style="width:8px;height:8px;background:var(--accent2);border-radius:50%;"></div>
            </div>
            <h1 style="font-size:clamp(32px,6vw,52px);font-weight:800;line-height:1.1;letter-spacing:-0.03em;margin-bottom:12px;">
                Crisis Pulse<br>
                <span style="color:var(--accent);">Analyser</span>
                <span style="font-size:0.35em;font-weight:600;background:var(--accent2);color:white;padding:4px 10px;border-radius:6px;vertical-align:middle;margin-left:8px;letter-spacing:0.08em;">PRO+</span>
            </h1>
            <p style="color:var(--text-muted);font-size:15px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏î‡πâ‡∏ß‡∏¢ AI</p>
        </div>

        <!-- Input Card -->
        <div class="card card-elevated" style="padding:32px;margin-bottom:20px;">
            <div class="accent-bar"></div>

            <!-- Situation + Forbidden Row -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
                <div>
                    <label style="display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:8px;">üé≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
                    <select id="situationSelect" class="input-field" onchange="toggleCustomSituation()" style="padding:11px 36px 11px 14px;">
                        <option value="‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏°‡∏µ‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå</option>
                        <option value="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ß‡∏µ‡πÑ‡∏≠‡∏û‡∏µ‡πÇ‡∏Å‡∏£‡∏ò‡∏à‡∏±‡∏î ‡πÇ‡∏ß‡∏¢‡∏ß‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ VIP ‡πÇ‡∏ß‡∏¢‡∏ß‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option>
                        <option value="‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô‡πÅ‡∏ô‡πà‡πÜ">‡πÄ‡∏à‡πâ‡∏≤‡∏ô‡∏≤‡∏¢‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</option>
                        <option value="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡∏•‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏°">‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πà‡∏° ‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡∏°</option>
                        <option value="custom">‚ú® ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á...</option>
                    </select>
                    <input type="text" id="customSituation" class="input-field hidden" style="margin-top:10px;" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå..." maxlength="200">
                </div>
                <div>
                    <label style="display:block;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);margin-bottom:8px;">üö´ ‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°</label>
                    <input type="text" id="forbiddenWordsInput" class="input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à, ‡∏†‡∏≤‡∏£‡∏∞" value="‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à, ‡∏†‡∏≤‡∏£‡∏∞" oninput="renderForbiddenTags()" style="padding:11px 14px;">
                    <div id="forbiddenTagsPreview" style="margin-top:8px;min-height:22px;"></div>
                </div>
            </div>

            <div class="divider" style="margin-bottom:24px;"></div>

            <!-- Text Input -->
            <div style="margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;">
                <label style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);">üí¨ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏û‡∏π‡∏î / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</label>
                <button id="micBtn" onclick="toggleRecording()" class="btn-secondary" style="padding:7px 14px;font-size:12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" style="width:14px;height:14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                    <span id="micText">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î</span>
                </button>
            </div>

            <textarea id="userInput" class="input-field" maxlength="500" oninput="updateCharCount()" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea>

            <div style="display:flex;align-items:center;justify-content:space-between;margin:8px 2px 24px;">
                <div id="forbiddenWarning" class="tag tag-red hidden">‚ö†Ô∏è ‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° ‚Äî ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0</div>
                <div style="flex:1;"></div>
                <span id="charCount" style="font-size:12px;color:var(--text-muted);font-weight:500;">0 / 500</span>
            </div>

            <button onclick="scan()" id="btn" class="btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
            </button>
        </div>

        <!-- Skeleton -->
        <div id="skeletonLoader" class="card hidden" style="padding:32px;">
            <div style="display:flex;gap:24px;align-items:center;margin-bottom:32px;padding-bottom:28px;border-bottom:1px solid var(--border);">
                <div class="shimmer" style="width:120px;height:120px;border-radius:50%;flex-shrink:0;"></div>
                <div style="flex:1;">
                    <div class="shimmer" style="height:14px;width:30%;margin-bottom:12px;"></div>
                    <div class="shimmer" style="height:28px;width:65%;margin-bottom:10px;"></div>
                    <div class="shimmer" style="height:14px;width:45%;"></div>
                </div>
            </div>
            <div class="shimmer" style="height:14px;width:40%;margin-bottom:12px;"></div>
            <div class="shimmer" style="height:12px;width:100%;margin-bottom:8px;"></div>
            <div class="shimmer" style="height:12px;width:85%;margin-bottom:8px;"></div>
            <div class="shimmer" style="height:12px;width:70%;margin-bottom:24px;"></div>
            <div class="shimmer" style="height:160px;width:100%;"></div>
        </div>

        <!-- Result -->
        <div id="result" class="hidden fade-in">

            <!-- Score Header Card -->
            <div class="card card-elevated" style="padding:32px;margin-bottom:16px;overflow:hidden;">
                <div class="accent-bar" id="toneBar"></div>
                <div style="display:flex;gap:28px;align-items:center;">
                    <!-- Ring -->
                    <div style="position:relative;flex-shrink:0;">
                        <svg style="width:120px;height:120px;transform:rotate(-90deg);" viewBox="0 0 128 128">
                            <circle cx="64" cy="64" r="52" stroke-width="10" fill="transparent" style="stroke:var(--border);"/>
                            <circle id="scoreRing" cx="64" cy="64" r="52" stroke="#d4500a" stroke-width="10" fill="transparent" stroke-dasharray="326.73" stroke-dashoffset="326.73" stroke-linecap="round"/>
                        </svg>
                        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                            <span id="scoreValue" style="font-family:'Syne',sans-serif;font-size:2.2rem;font-weight:800;line-height:1;color:var(--text);">0</span>
                            <span style="font-size:11px;color:var(--text-muted);font-weight:600;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                        </div>
                    </div>
                    <!-- Info -->
                    <div style="flex:1;min-width:0;">
                        <div id="toneBadge" class="tag" style="margin-bottom:12px;">‚Äî</div>
                        <h2 style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:4px;letter-spacing:-0.02em;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
                        <p style="color:var(--text-muted);font-size:13px;">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö AI Crisis Communication</p>
                        <div id="scoreLabel" style="font-size:12px;font-weight:700;margin-top:8px;"></div>
                    </div>
                </div>
            </div>

            <!-- Report Content -->
            <div id="reportContent"></div>

            <!-- Export Image Only -->
            <div style="margin-top:16px;">
                <button onclick="exportImage()" id="exportBtn" class="btn-secondary" style="width:100%;justify-content:center;padding:14px 20px;font-size:14px;">
                    <svg xmlns="http://www.w3.org/2000/svg" style="width:16px;height:16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </button>
            </div>
        </div>

    </div>

    <script>
        const RATE_LIMIT_MS = 10000;
        let lastSubmitTime = 0;
        let recognition, isRecording = false;

        // Speech
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'th-TH';
            recognition.onresult = (e) => {
                let t = '';
                for (let i = e.resultIndex; i < e.results.length; i++)
                    if (e.results[i].isFinal) t += e.results[i][0].transcript;
                if (t) {
                    const inp = document.getElementById('userInput');
                    inp.value = (inp.value + ' ' + t).trim().slice(0, 500);
                    updateCharCount();
                }
            };
            recognition.onend = stopRecording;
            recognition.onerror = (e) => { stopRecording(); showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.error); };
        } else {
            document.getElementById('micBtn').style.display = 'none';
        }

        function toggleRecording() {
            if (!recognition) return;
            if (isRecording) { stopRecording(); }
            else {
                recognition.start(); isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('micText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...';
            }
        }
        function stopRecording() {
            if (recognition && isRecording) recognition.stop();
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');
            document.getElementById('micText').textContent = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î';
        }

        // Theme
        function toggleDark() {
            document.documentElement.classList.toggle('dark');
            const d = document.documentElement.classList.contains('dark');
            document.getElementById('themeIcon').textContent = d ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', d ? 'dark' : 'light');
        }

        window.onload = () => {
            const t = localStorage.getItem('theme');
            if (t === 'dark' || (!t && matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
            }
            renderForbiddenTags();
        };

        function toggleCustomSituation() {
            const v = document.getElementById('situationSelect').value;
            const inp = document.getElementById('customSituation');
            if (v === 'custom') { inp.classList.remove('hidden'); setTimeout(() => inp.focus(), 80); }
            else inp.classList.add('hidden');
        }

        function showError(msg) {
            document.getElementById('modalMsg').textContent = msg;
            document.getElementById('modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function formatText(t) {
            if (!t) return '';
            return t.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight:700;color:var(--text)">$1</strong>');
        }

        function updateCharCount() {
            const l = document.getElementById('userInput').value.length;
            const el = document.getElementById('charCount');
            el.textContent = `${l} / 500`;
            el.className = l >= 500 ? 'char-danger' : l > 450 ? 'char-warn' : '';
            el.style.cssText = l >= 500 ? 'font-size:12px;font-weight:700;' : l > 450 ? 'font-size:12px;font-weight:700;color:#d97706;' : 'font-size:12px;color:var(--text-muted);';
            checkForbidden();
        }

        function getForbiddenWords() {
            return document.getElementById('forbiddenWordsInput').value.split(',').map(w => w.trim()).filter(Boolean);
        }

        function renderForbiddenTags() {
            const words = getForbiddenWords();
            document.getElementById('forbiddenTagsPreview').innerHTML =
                words.map(w => `<span class="forbidden-tag">üö´ ${w}</span>`).join('');
            checkForbidden();
        }

        function checkForbidden() {
            const t = document.getElementById('userInput').value.toLowerCase();
            const found = getForbiddenWords().some(w => w && t.includes(w.toLowerCase()));
            document.getElementById('forbiddenWarning').classList.toggle('hidden', !found);
        }

        async function scan() {
            const now = Date.now();
            if (now - lastSubmitTime < RATE_LIMIT_MS) {
                const w = Math.ceil((RATE_LIMIT_MS - (now - lastSubmitTime)) / 1000);
                return showError(`‚è±Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${w} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö`);
            }
            const text = document.getElementById('userInput').value.trim();
            if (!text) return showError('üö® ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö');
            const sv = document.getElementById('situationSelect').value;
            const cv = document.getElementById('customSituation').value.trim();
            const situation = sv === 'custom' ? cv : sv;
            if (sv === 'custom' && !situation) return showError('‚úçÔ∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');
            const forbiddenWords = getForbiddenWords();
            const btn = document.getElementById('btn');
            const sk = document.getElementById('skeletonLoader');
            const res = document.getElementById('result');
            btn.disabled = true;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;animation:spin 1s linear infinite;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';
            res.classList.add('hidden'); sk.classList.remove('hidden');
            lastSubmitTime = Date.now();
            const style = document.createElement('style');
            style.textContent = '@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}';
            document.head.appendChild(style);
            try {
                const r = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, situation, forbiddenWords })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.error || 'Connection Error');
                sk.classList.add('hidden');
                updateUI(data);
                res.classList.remove('hidden');
                res.classList.add('fade-in');
                setTimeout(() => res.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            } catch (err) {
                showError(err.message);
                sk.classList.add('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" style="width:18px;height:18px;" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£';
            }
        }

        const TONES = {
            Aggressive: { label: 'üî¥ ‡∏Å‡πâ‡∏≤‡∏ß‡∏£‡πâ‡∏≤‡∏ß / ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏∞‡∏ó‡∏∞', tagClass: 'tag-red', bar: '#c0211f', ringClass: 'ring-poor' },
            Professional: { label: 'üü¢ ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û / ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', tagClass: 'tag-green', bar: '#1a6b3a', ringClass: 'ring-excellent' },
            Passive: { label: '‚ö™ ‡∏ô‡∏¥‡πà‡∏á‡πÄ‡∏â‡∏¢ / ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à', tagClass: 'tag-blue', bar: '#64748b', ringClass: 'ring-good' },
            Neutral: { label: 'üîµ ‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', tagClass: 'tag-blue', bar: '#1a4f8a', ringClass: 'ring-good' }
        };

        function updateUI(data) {
            const score = data.score || 0;
            const tone = data.tone || 'Neutral';
            const t = TONES[tone] || TONES.Neutral;

            // Ring
            const ring = document.getElementById('scoreRing');
            ring.style.strokeDashoffset = 326.73;
            ring.className = '';
            ring.style.stroke = t.bar;

            setTimeout(() => {
                ring.style.strokeDashoffset = 326.73 - (score / 100 * 326.73);
                const el = document.getElementById('scoreValue');
                let cur = 0;
                const step = Math.max(1, Math.ceil(score / 60));
                const iv = setInterval(() => {
                    cur = Math.min(cur + step, score);
                    el.textContent = cur;
                    if (cur >= score) clearInterval(iv);
                }, 16);
            }, 80);

            // Tone bar & badge
            document.getElementById('toneBar').style.background = t.bar;
            const badge = document.getElementById('toneBadge');
            badge.textContent = t.label;
            badge.className = 'tag ' + t.tagClass;
            badge.style.marginBottom = '12px';

            // Score label
            const sl = document.getElementById('scoreLabel');
            if (score >= 80) { sl.textContent = '‚ú® ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ‚Äî ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å'; sl.style.color = 'var(--green)'; }
            else if (score >= 60) { sl.textContent = 'üëç ‡∏î‡∏µ ‚Äî ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÑ‡∏î‡πâ'; sl.style.color = 'var(--accent2)'; }
            else if (score >= 40) { sl.textContent = 'üìä ‡∏û‡∏≠‡πÉ‡∏ä‡πâ ‚Äî ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î'; sl.style.color = '#d97706'; }
            else { sl.textContent = '‚ö° ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡πà‡∏ß‡∏ô ‚Äî ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥'; sl.style.color = 'var(--red)'; }

            let html = '';

            // Summary
            if (data.summary) {
                html += `<div class="card" style="padding:24px;margin-bottom:16px;border-left:4px solid var(--accent);">
                    <div class="section-label" style="margin-bottom:10px;">üìù ‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
                    <p style="font-size:14px;line-height:1.75;color:var(--text);">${formatText(data.summary)}</p>
                </div>`;
            }

            // Pros & Cons
            if ((data.pros?.length || data.cons?.length)) {
                html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">`;
                if (data.pros?.length) {
                    html += `<div class="card" style="padding:20px;border-top:3px solid var(--green);">
                        <div class="section-label" style="margin-bottom:12px;color:var(--green);">‚úÖ ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô</div>`;
                    data.pros.forEach(i => html += `<div class="list-item">
                        <div class="list-dot" style="background:var(--green-light);color:var(--green);">‚úì</div>
                        <span>${formatText(i)}</span>
                    </div>`);
                    html += `</div>`;
                }
                if (data.cons?.length) {
                    html += `<div class="card" style="padding:20px;border-top:3px solid var(--red);">
                        <div class="section-label" style="margin-bottom:12px;color:var(--red);">‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>`;
                    data.cons.forEach(i => html += `<div class="list-item">
                        <div class="list-dot" style="background:var(--red-light);color:var(--red);">!</div>
                        <span>${formatText(i)}</span>
                    </div>`);
                    html += `</div>`;
                }
                html += `</div>`;
            }

            // Comparison table
            if (data.comparison_table?.length) {
                html += `<div class="card" style="padding:24px;margin-bottom:16px;overflow:hidden;">
                    <div class="section-label" style="margin-bottom:16px;">üí° ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Best Practice)</div>
                    <div style="overflow:hidden;border-radius:10px;border:1px solid var(--border);">
                    <table class="result-table">
                        <thead><tr>
                            <th style="width:22%;">‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô</th>
                            <th style="width:38%;">‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÄ‡∏î‡∏¥‡∏°</th>
                            <th>‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th>
                        </tr></thead>
                        <tbody>`;
                data.comparison_table.forEach(row => {
                    html += `<tr>
                        <td style="font-weight:600;font-size:12px;color:var(--text-muted);">${formatText(row.aspect)}</td>
                        <td>${formatText(row.original)}</td>
                        <td style="color:var(--green);font-weight:600;">${formatText(row.better)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div></div>`;
            }

            document.getElementById('reportContent').innerHTML = html;
        }

        // Export image
        function exportImage() {
            const area = document.getElementById('result');
            const btn = document.getElementById('exportBtn');
            const orig = btn.innerHTML;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...';
            btn.disabled = true;
            const wasDark = document.documentElement.classList.contains('dark');
            if (wasDark) document.documentElement.classList.remove('dark');
            const cleanup = () => {
                btn.innerHTML = orig;
                btn.disabled = false;
                if (wasDark) document.documentElement.classList.add('dark');
            };
            setTimeout(() => {
                html2canvas(area, { backgroundColor: '#f8f5f0', scale: 2, useCORS: true, scrollY: 0 })
                    .then(canvas => {
                        const a = document.createElement('a');
                        a.download = `Crisis-Report-${Date.now()}.png`;
                        a.href = canvas.toDataURL('image/png');
                        a.click();
                        cleanup();
                    })
                    .catch(() => { showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); cleanup(); });
            }, 500);
        }
    </script>
</body>
</html>